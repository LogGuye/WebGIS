{% extends "base.html" %}
{% block title %}Nearby Search | GeoEstate{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb-strip">
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:home' %}"><i class="bi bi-house me-1"></i>Home</a></li>
        <li class="breadcrumb-item active">Nearby Search</li>
      </ol>
    </nav>
  </div>
</div>
{% endblock %}

{% block head %}
<style>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     NEARBY SEARCH â€” all colors via var() tokens
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* â”€â”€ Page hero â”€â”€ */
  .page-hero {
    background: var(--bg-2);
    border-bottom: 1px solid var(--border);
    padding: 48px 0 40px;
  }

  .page-icon {
    width: 52px; height: 52px;
    background: var(--gold-dim); border: 1px solid var(--gold-border);
    border-radius: var(--radius-md);
    display: grid; place-items: center;
    font-size: 24px; margin-bottom: 16px;
  }

  .page-eyebrow {
    font-size: 10.5px; font-weight: 600; letter-spacing: 3px;
    text-transform: uppercase; color: var(--gold); margin-bottom: 6px;
  }

  .page-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(1.6rem, 3vw, 2.2rem);
    font-weight: 700; color: var(--text); line-height: 1.15; margin-bottom: 6px;
  }

  .page-desc {
    color: var(--text-muted); font-size: 14px;
    font-weight: 300; line-height: 1.7; max-width: 480px;
  }

  /* â”€â”€ Search panel â”€â”€ */
  .search-panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    padding: 32px;
    box-shadow: var(--shadow-card);
    margin: 36px 0;
  }

  .panel-section-label {
    font-size: 11px; font-weight: 600; letter-spacing: 2px;
    text-transform: uppercase; color: var(--gold);
    margin-bottom: 20px;
    display: flex; align-items: center; gap: 8px;
  }

  .panel-section-label::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  .field-label {
    font-size: 11.5px; font-weight: 600; letter-spacing: .5px;
    color: var(--text-dim); margin-bottom: 8px; display: block;
  }

  .field-label i { color: var(--gold); margin-right: 5px; }

  .field-input {
    background: var(--bg-3); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text);
    font-family: 'Outfit', sans-serif; font-size: 14px;
    padding: 10px 14px; outline: none; width: 100%;
    transition: border-color var(--transition), box-shadow var(--transition);
  }

  .field-input::placeholder { color: var(--text-muted); }

  .field-input:focus {
    border-color: var(--gold-border);
    box-shadow: 0 0 0 3px var(--gold-dim);
  }

  .field-input option { background: var(--bg-2); }

  .coord-hint {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; color: var(--text-muted); margin-top: 6px;
  }

  /* Quick presets */
  .quick-locs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }

  .quick-loc-btn {
    background: var(--bg-3); border: 1px solid var(--border);
    border-radius: 999px; padding: 5px 14px;
    font-size: 12px; font-weight: 500; color: var(--text-dim);
    cursor: pointer; transition: all var(--transition);
    font-family: 'Outfit', sans-serif;
  }

  .quick-loc-btn:hover {
    border-color: var(--gold-border); color: var(--gold); background: var(--gold-dim);
  }

  /* Radius slider */
  .radius-track { display: flex; align-items: center; gap: 12px; margin-top: 4px; }

  input[type="range"].geo-range {
    flex: 1; -webkit-appearance: none; appearance: none;
    height: 4px; border-radius: 2px;
    background: linear-gradient(to right, var(--gold) 0%, var(--gold) var(--pct,30%), var(--bg-3) var(--pct,30%));
    outline: none; cursor: pointer;
  }

  input[type="range"].geo-range::-webkit-slider-thumb {
    -webkit-appearance: none; width: 18px; height: 18px;
    border-radius: 50%; background: var(--gold);
    border: 2px solid var(--bg); box-shadow: 0 2px 8px rgba(200,169,110,.4);
    cursor: pointer; transition: transform var(--transition);
  }

  input[type="range"].geo-range::-webkit-slider-thumb:hover { transform: scale(1.2); }

  .radius-val {
    min-width: 56px; text-align: center;
    font-size: 13px; font-weight: 600; color: var(--gold);
    background: var(--gold-dim); border: 1px solid var(--gold-border);
    border-radius: var(--radius-sm); padding: 4px 8px;
  }

  /* Property type chips */
  .type-chips { display: flex; flex-wrap: wrap; gap: 8px; }

  .type-chip {
    display: flex; align-items: center; gap: 6px;
    padding: 7px 16px; border-radius: 999px;
    border: 1px solid var(--border); background: var(--bg-3);
    color: var(--text-dim); font-size: 12.5px; font-weight: 500;
    cursor: pointer; transition: all var(--transition);
    font-family: 'Outfit', sans-serif; white-space: nowrap; user-select: none;
  }

  .type-chip:hover { border-color: var(--gold-border); color: var(--gold); background: var(--gold-dim); }
  .type-chip.active { background: var(--gold-dim); border-color: var(--gold-border); color: var(--gold); font-weight: 600; }

  /* Search button */
  .btn-search-main {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    width: 100%; padding: 13px;
    background: var(--gold); color: #0C0F1A;
    border: none; border-radius: var(--radius-md);
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: all var(--transition);
  }

  .btn-search-main:hover {
    background: var(--gold-light);
    box-shadow: 0 8px 24px rgba(200,169,110,.35);
    transform: translateY(-2px);
  }

  /* â”€â”€ Two-column layout â”€â”€ */
  .results-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 1024px) {
    .results-layout { grid-template-columns: 1fr; }
    .map-sticky { position: static !important; }
  }

  /* â”€â”€ Results header â”€â”€ */
  .results-header {
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 12px; margin-bottom: 16px;
  }

  .results-count { display: flex; align-items: center; gap: 10px; }

  .count-badge {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2rem; font-weight: 700; color: var(--gold); line-height: 1;
  }

  .count-label { font-size: 13px; color: var(--text-muted); }

  /* Sort select */
  .sort-select {
    background: var(--bg-3); border: 1px solid var(--border);
    color: var(--text); border-radius: var(--radius-sm);
    padding: 7px 12px; font-family: 'Outfit', sans-serif;
    font-size: 13px; outline: none; cursor: pointer;
    transition: border-color var(--transition);
  }

  .sort-select:focus { border-color: var(--gold-border); }
  .sort-select option { background: var(--bg-2); }

  /* â”€â”€ Property cards â”€â”€ */
  .prop-list { display: flex; flex-direction: column; gap: 12px; }

  .prop-item {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); overflow: hidden;
    display: grid; grid-template-columns: 160px 1fr auto;
    transition: border-color var(--transition), transform var(--transition), box-shadow var(--transition);
  }

  .prop-item:hover {
    border-color: var(--border-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-card), var(--shadow-glow);
  }

  /* Thumb */
  .prop-thumb {
    background: linear-gradient(135deg, var(--bg-2) 0%, var(--bg-3) 100%);
    display: flex; align-items: center; justify-content: center;
    font-size: 36px; position: relative; min-height: 120px;
  }

  .prop-type-badge {
    position: absolute; bottom: 8px; left: 8px;
  }

  /* Body */
  .prop-body { padding: 16px 18px; min-width: 0; }

  .prop-title {
    font-size: 15px; font-weight: 600; color: var(--text);
    margin-bottom: 4px; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis;
  }

  .prop-address {
    font-size: 12.5px; color: var(--text-muted); margin-bottom: 10px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .prop-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }

  .prop-tag {
    font-size: 11px; font-weight: 500; color: var(--text-dim);
    background: var(--bg-3); border: 1px solid var(--border);
    border-radius: 6px; padding: 3px 9px;
    display: flex; align-items: center; gap: 4px;
  }

  .prop-price {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.2rem; font-weight: 700; color: var(--gold);
  }

  /* Right side */
  .prop-right {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 10px; padding: 16px;
    border-left: 1px solid var(--border);
    min-width: 90px;
  }

  .dist-pill {
    display: flex; flex-direction: column; align-items: center;
    background: var(--gold-dim); border: 1px solid var(--gold-border);
    border-radius: var(--radius-sm); padding: 10px 14px; width: 100%;
    text-align: center;
  }

  .dist-num {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.35rem; font-weight: 700; color: var(--gold); line-height: 1;
  }

  .dist-unit { font-size: 10px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; }

  .btn-view {
    display: flex; align-items: center; justify-content: center; gap: 5px;
    width: 100%; padding: 8px 10px;
    background: transparent; color: var(--text-dim);
    border: 1px solid var(--border); border-radius: var(--radius-sm);
    font-family: 'Outfit', sans-serif; font-size: 12px; font-weight: 500;
    text-decoration: none; transition: all var(--transition); white-space: nowrap;
  }

  .btn-view:hover {
    border-color: var(--gold-border); color: var(--gold); background: var(--gold-dim);
  }

  /* â”€â”€ Map sidebar â”€â”€ */
  .map-sticky {
    position: sticky; top: calc(var(--nav-h) + 16px);
  }

  .map-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-xl); overflow: hidden;
    box-shadow: var(--shadow-card);
  }

  .map-card-header {
    padding: 14px 18px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }

  .map-card-title {
    font-size: 12px; font-weight: 600; letter-spacing: 1.5px;
    text-transform: uppercase; color: var(--gold);
    display: flex; align-items: center; gap: 7px;
  }

  .map-live-dot {
    width: 7px; height: 7px; border-radius: 50%; background: #22c55e;
    animation: heroPulse 2s infinite;
  }

  @keyframes heroPulse {
    0%,100% { opacity:1; transform:scale(1); }
    50%      { opacity:.3; transform:scale(.6); }
  }

  .map-iframe-wrap { position: relative; height: 340px; }

  .map-iframe-wrap iframe {
    width: 100%; height: 100%; border: none;
    filter: brightness(.82) saturate(.55) hue-rotate(185deg);
    transition: filter var(--transition);
  }

  [data-theme="light"] .map-iframe-wrap iframe { filter: brightness(.95) saturate(.75); }

  /* radius circle overlay hint */
  .map-iframe-wrap::after {
    content: ''; position: absolute; inset: 0; pointer-events: none;
    background: radial-gradient(circle at 50% 50%, rgba(200,169,110,.06) 0%, transparent 65%);
  }

  .map-card-footer {
    padding: 12px 18px; border-top: 1px solid var(--border);
    font-size: 12px; color: var(--text-muted);
    display: flex; align-items: center; gap: 6px;
  }

  /* â”€â”€ Empty state â”€â”€ */
  .empty-state {
    text-align: center; padding: 64px 24px;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-xl); color: var(--text-muted);
  }

  .empty-state .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: .5; }
  .empty-state h5 { color: var(--text); font-size: 16px; margin-bottom: 8px; }
  .empty-state p  { font-size: 14px; max-width: 360px; margin: 0 auto; line-height: 1.7; }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 768px) {
    .search-panel { padding: 20px; }
    .prop-item { grid-template-columns: 120px 1fr; }
    .prop-right { display: none; }
    .prop-item .dist-pill-inline {
      display: inline-flex; align-items: center; gap: 4px;
    }
  }

  @media (max-width: 480px) {
    .prop-item { grid-template-columns: 1fr; }
    .prop-thumb { min-height: 140px; }
  }
</style>
{% endblock %}

{% block content %}

<!-- â•â• PAGE HERO â•â• -->
<div class="page-hero">
  <div class="container">
    <div class="page-icon">ğŸ“</div>
    <p class="page-eyebrow">Spatial Search</p>
    <h1 class="page-title">Nearby Properties</h1>
    <p class="page-desc">
      Find properties within any radius of a location using PostGIS spatial queries.
      Filter by property type and sort by distance.
    </p>
  </div>
</div>

<div class="container" style="padding-bottom:80px">

  <!-- â•â• SEARCH PANEL â•â• -->
  <div class="search-panel fade-up">
    <div class="panel-section-label">
      <i class="bi bi-sliders me-1"></i> Search Parameters
    </div>

    <!-- Quick presets -->
    <div style="margin-bottom:20px">
      <div class="field-label"><i class="bi bi-lightning-charge"></i>Quick locations</div>
      <div class="quick-locs">
        <button type="button" class="quick-loc-btn" data-lat="10.7769" data-lng="106.7009">ğŸ“ District 1</button>
        <button type="button" class="quick-loc-btn" data-lat="10.8020" data-lng="106.7330">ğŸ“ Thao Dien</button>
        <button type="button" class="quick-loc-btn" data-lat="10.7299" data-lng="106.6955">ğŸ“ District 7</button>
        <button type="button" class="quick-loc-btn" data-lat="10.8517" data-lng="106.7717">ğŸ“ Thu Duc</button>
        <button type="button" class="quick-loc-btn" data-lat="10.7626" data-lng="106.6602">ğŸ“ Binh Thanh</button>
        <button type="button" class="quick-loc-btn" id="btnGeolocate">
          <i class="bi bi-crosshair"></i> My location
        </button>
      </div>
    </div>

    <form method="get" id="nearbyForm">
      <div class="row g-3 align-items-start">

        <!-- Lat -->
        <div class="col-md-3 col-sm-6">
          <label class="field-label" for="idLat"><i class="bi bi-compass"></i>Latitude</label>
          <input type="text" id="idLat" name="lat" class="field-input"
                 placeholder="e.g. 10.7769" value="{{ params.lat }}" required />
          <div class="coord-hint">
            <i class="bi bi-info-circle" style="font-size:11px"></i> Decimal degrees (WGS84)
          </div>
        </div>

        <!-- Lng -->
        <div class="col-md-3 col-sm-6">
          <label class="field-label" for="idLng"><i class="bi bi-compass"></i>Longitude</label>
          <input type="text" id="idLng" name="lng" class="field-input"
                 placeholder="e.g. 106.7009" value="{{ params.lng }}" required />
        </div>

        <!-- Radius slider -->
        <div class="col-md-3 col-sm-6">
          <label class="field-label" for="idRadiusSlider"><i class="bi bi-circle"></i>Radius</label>
          <div class="radius-track">
            <input type="range" id="idRadiusSlider" class="geo-range"
                   min="0.1" max="20" step="0.1" value="{{ params.radius|default:'2' }}" />
            <div class="radius-val" id="radiusDisplay">{{ params.radius|default:"2.0" }} km</div>
          </div>
          <input type="hidden" id="idRadius" name="radius" value="{{ params.radius|default:'2' }}" />
        </div>

        <!-- Property type select (hidden, driven by chips) -->
        <div class="col-md-3 col-sm-6">
          <label class="field-label" for="idType"><i class="bi bi-buildings"></i>Property type</label>
          <select id="idType" name="type" class="field-input">
            <option value="">All types</option>
            <option value="apartment" {% if params.type == "apartment" %}selected{% endif %}>Apartment</option>
            <option value="house"     {% if params.type == "house"     %}selected{% endif %}>House</option>
            <option value="land"      {% if params.type == "land"      %}selected{% endif %}>Land</option>
          </select>
        </div>

        <!-- Type chips (visual, synced to select) -->
        <div class="col-12">
          <label class="field-label"><i class="bi bi-grid"></i>Filter by type</label>
          <div class="type-chips" id="typeChips">
            <div class="type-chip {% if not params.type %}active{% endif %}" data-val="">
              <i class="bi bi-asterisk"></i> All
            </div>
            <div class="type-chip {% if params.type == 'apartment' %}active{% endif %}" data-val="apartment">
              ğŸ¢ Apartment
            </div>
            <div class="type-chip {% if params.type == 'house' %}active{% endif %}" data-val="house">
              ğŸ  House
            </div>
            <div class="type-chip {% if params.type == 'land' %}active{% endif %}" data-val="land">
              ğŸŒ¿ Land
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="col-12 col-md-4 col-lg-3 ms-auto">
          <button type="submit" class="btn-search-main">
            <i class="bi bi-search"></i> Search Nearby
          </button>
        </div>

      </div>
    </form>
  </div>

  <!-- â•â• RESULTS â•â• -->
  {% if results != None %}

  <div class="results-layout">

    <!-- Left: property list -->
    <div>
      <div class="results-header fade-up">
        <div class="results-count">
          <span class="count-badge">{{ results|length }}</span>
          <span class="count-label">
            propert{{ results|length|pluralize:"y,ies" }} found
            {% if params.radius %} within {{ params.radius }} km{% endif %}
          </span>
        </div>

        <div class="d-flex align-items-center gap-2">
          <label class="field-label mb-0" style="white-space:nowrap">Sort by</label>
          <select class="sort-select" id="sortSelect">
            <option value="distance">Distance â†‘</option>
            <option value="price_asc">Price â†‘</option>
            <option value="price_desc">Price â†“</option>
            <option value="area">Area â†“</option>
          </select>
        </div>
      </div>

      {% if results %}
      <div class="prop-list fade-up" id="propList">
        {% for p in results %}
        <div class="prop-item"
             data-distance="{{ p.distance.km }}"
             data-price="{{ p.price|default:0 }}"
             data-area="{{ p.area|default:0 }}">

          <!-- Thumb -->
          <div class="prop-thumb">
            {% with t=p.get_property_type_display|lower %}
              {% if "apartment" in t %}ğŸ¢
              {% elif "house" in t %}ğŸ 
              {% elif "land" in t %}ğŸŒ¿
              {% elif "villa" in t %}ğŸ¡
              {% else %}ğŸ—ï¸
              {% endif %}
            {% endwith %}
            <div class="prop-type-badge">
              <span class="badge-gold" style="font-size:9px">{{ p.get_property_type_display }}</span>
            </div>
          </div>

          <!-- Body -->
          <div class="prop-body">
            <div class="prop-title">{{ p.title }}</div>
            <div class="prop-address">
              <i class="bi bi-geo-alt me-1" style="color:var(--gold)"></i>{{ p.address }}
            </div>
            <div class="prop-tags">
              {% if p.area %}
              <span class="prop-tag"><i class="bi bi-aspect-ratio"></i> {{ p.area }} mÂ²</span>
              {% endif %}
              {% if p.bedrooms %}
              <span class="prop-tag"><i class="bi bi-door-open"></i> {{ p.bedrooms }} bed</span>
              {% endif %}
              {% if p.bathrooms %}
              <span class="prop-tag"><i class="bi bi-droplet"></i> {{ p.bathrooms }} bath</span>
              {% endif %}
            </div>
            {% if p.price %}
            <div class="prop-price">
              {{ p.price|floatformat:0 }} <span style="font-size:.85rem;font-weight:400;color:var(--text-muted)">VND</span>
            </div>
            {% endif %}
          </div>

          <!-- Right: distance + CTA -->
          <div class="prop-right">
            <div class="dist-pill">
              <span class="dist-num">{{ p.distance.km|floatformat:2 }}</span>
              <span class="dist-unit">km</span>
            </div>
            <a class="btn-view" href="{% url 'properties:detail' p.pk %}">
              <i class="bi bi-eye"></i> View
            </a>
          </div>

        </div>
        {% endfor %}
      </div>

      {% else %}
      <div class="empty-state fade-up">
        <div class="empty-icon">ğŸ”</div>
        <h5>No properties found</h5>
        <p>Try increasing the search radius or changing the property type filter. Make sure your coordinates are within the mapped area.</p>
      </div>
      {% endif %}
    </div>

    <!-- Right: map sidebar -->
    <div class="map-sticky">
      <div class="map-card fade-up">
        <div class="map-card-header">
          <div class="map-card-title">
            <div class="map-live-dot"></div>
            Search Area
          </div>
          <span style="font-size:11px;color:var(--text-muted)">
            {% if params.radius %}r = {{ params.radius }} km{% endif %}
          </span>
        </div>

        <div class="map-iframe-wrap">
          {% if params.lat and params.lng %}
          <iframe
            src="https://www.openstreetmap.org/export/embed.html?bbox={{ params.lng|add:'-0.05' }},{{ params.lat|add:'-0.04' }},{{ params.lng|add:'0.05' }},{{ params.lat|add:'0.04' }}&layer=mapnik&marker={{ params.lat }},{{ params.lng }}"
            allowfullscreen loading="lazy"
            title="Search area map">
          </iframe>
          {% else %}
          <iframe
            src="https://www.openstreetmap.org/export/embed.html?bbox=106.5,10.65,106.85,10.9&layer=mapnik"
            allowfullscreen loading="lazy"
            title="Ho Chi Minh City map">
          </iframe>
          {% endif %}
        </div>

        <div class="map-card-footer">
          <i class="bi bi-info-circle" style="color:var(--gold)"></i>
          {% if params.lat and params.lng %}
            Centered at {{ params.lat }}, {{ params.lng }}
          {% else %}
            Enter coordinates to focus the map
          {% endif %}
        </div>
      </div>

      <!-- Mini stat cards -->
      {% if results %}
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px;text-align:center">
          <div style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:700;color:var(--gold)">
            {{ results|length }}
          </div>
          <div style="font-size:10px;color:var(--text-muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px">Found</div>
        </div>
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px;text-align:center">
          <div style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:700;color:var(--gold)">
            {{ results.0.distance.km|floatformat:1 }}
          </div>
          <div style="font-size:10px;color:var(--text-muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px">Min km</div>
        </div>
      </div>
      {% endif %}

    </div>

  </div><!-- /results-layout -->

  {% endif %}

</div><!-- /container -->

{% endblock %}

{% block scripts %}
<script>
(function () {
  /* â”€â”€ Radius slider â”€â”€ */
  const slider  = document.getElementById('idRadiusSlider');
  const display = document.getElementById('radiusDisplay');
  const hidden  = document.getElementById('idRadius');

  function updateSlider(val) {
    const min = parseFloat(slider.min), max = parseFloat(slider.max);
    const pct = ((val - min) / (max - min) * 100).toFixed(1) + '%';
    slider.style.setProperty('--pct', pct);
    display.textContent = parseFloat(val).toFixed(1) + ' km';
    hidden.value = val;
  }

  if (slider) {
    updateSlider(slider.value);
    slider.addEventListener('input', () => updateSlider(slider.value));
  }

  /* â”€â”€ Type chips â†’ select sync â”€â”€ */
  const chips  = document.querySelectorAll('.type-chip');
  const select = document.getElementById('idType');

  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      chips.forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      if (select) select.value = chip.dataset.val;
    });
  });

  if (select) {
    select.addEventListener('change', () => {
      chips.forEach(c => c.classList.toggle('active', c.dataset.val === select.value));
    });
  }

  /* â”€â”€ Quick location presets â”€â”€ */
  document.querySelectorAll('.quick-loc-btn[data-lat]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('idLat').value = btn.dataset.lat;
      document.getElementById('idLng').value = btn.dataset.lng;
    });
  });

  /* â”€â”€ Geolocation â”€â”€ */
  const geoBtn = document.getElementById('btnGeolocate');
  if (geoBtn) {
    geoBtn.addEventListener('click', () => {
      if (!navigator.geolocation) { alert('Geolocation not supported.'); return; }
      geoBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Locatingâ€¦';
      geoBtn.disabled = true;

      navigator.geolocation.getCurrentPosition(
        pos => {
          document.getElementById('idLat').value = pos.coords.latitude.toFixed(6);
          document.getElementById('idLng').value = pos.coords.longitude.toFixed(6);
          geoBtn.innerHTML = '<i class="bi bi-check-circle"></i> Location set';
          setTimeout(() => {
            geoBtn.innerHTML = '<i class="bi bi-crosshair"></i> My location';
            geoBtn.disabled = false;
          }, 2000);
        },
        () => {
          alert('Unable to retrieve your location.');
          geoBtn.innerHTML = '<i class="bi bi-crosshair"></i> My location';
          geoBtn.disabled = false;
        }
      );
    });
  }

  /* â”€â”€ Client-side sort â”€â”€ */
  const sortSelect = document.getElementById('sortSelect');
  const propList   = document.getElementById('propList');

  if (sortSelect && propList) {
    sortSelect.addEventListener('change', () => {
      const items = [...propList.querySelectorAll('.prop-item')];
      const key   = sortSelect.value;

      items.sort((a, b) => {
        if (key === 'distance')   return parseFloat(a.dataset.distance) - parseFloat(b.dataset.distance);
        if (key === 'price_asc')  return parseFloat(a.dataset.price)    - parseFloat(b.dataset.price);
        if (key === 'price_desc') return parseFloat(b.dataset.price)    - parseFloat(a.dataset.price);
        if (key === 'area')       return parseFloat(b.dataset.area)     - parseFloat(a.dataset.area);
        return 0;
      });

      items.forEach(item => propList.appendChild(item));
    });
  }

})();
</script>

<style>
  @keyframes spin { to { transform: rotate(360deg); } }
  .spin { display: inline-block; animation: spin .7s linear infinite; }
</style>
{% endblock %}
